
<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>♥</title>
	
	<script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular.min.js"></script>
	<script type='text/javascript' src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css">

	<style type='text/css'>
        div[ng-app] {
            padding: 20px;
        }

        div[contenteditable] {
        	display: block;
        	background-color: #f0f0f0;
        	padding: 10px;
        	outline-style: none;
        	height: 200px;
        	margin: 10px 0 50px 0;
        	overflow-y: auto;

        	font-size: 12px !important;
        	line-height: 20px !important;
        	
        	-webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        	-moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        	box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        	-webkit-transition: border linear .2s, box-shadow linear .2s;
        	-moz-transition: border linear .2s, box-shadow linear .2s;
        	-o-transition: border linear .2s, box-shadow linear .2s;
        	transition: border linear .2s, box-shadow linear .2s;
        }



        textarea, pre {
        	width:100%;
        	-webkit-box-sizing: border-box;
        	-moz-box-sizing: border-box;
        	box-sizing: border-box;
        	background-color: #f0f0f0;
        	border: none;
        	border-radius: 0;
        	padding: 10px;
        	outline-style: none;
        	height: 250px;
        	margin: 10px 0 20px 0;
        	overflow-y: auto;
        	
        	font-size: 12px !important;
        	line-height: 20px !important;
        	
        	-webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        	-moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        	box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        	-webkit-transition: border linear .2s, box-shadow linear .2s;
        	-moz-transition: border linear .2s, box-shadow linear .2s;
        	-o-transition: border linear .2s, box-shadow linear .2s;
        	transition: border linear .2s, box-shadow linear .2s;
        }

        button {
        	font-size: 12px !important;
        	font-weight: bold;
        }

        blockquote {
        	margin-top: 20px;
        	margin-bottom: 0;
        }

        /* IE + Others */
        div[contenteditable] blockquote {
        	border-left: none;
        	font-size: inherit;
        	font-weight: normal;
        	margin-top: 0;
        }

        /* IE */
        div[contenteditable] blockquote p {
        	border-left: none;
        	font-size: inherit;
        	font-weight: normal;
        	line-height: 30px;
        	margin-top: -5px;
        	margin-bottom: 5px;
        	margin-left: 30px;
        }

        div[contenteditable] ul, div[contenteditable] ol {
        	margin-left: 60px;
        }

	</style>
	


    <script type='text/javascript'>

angular.module('directive', [])

	.directive('contenteditable', function () {
		return {
			require: 'ngModel',
			link: function (scope, elm, attrs, ctrl) {
					
				//초기화
				scope.init = function () {
						//결과 출력
						scope.convert("");
						
						//에디터 초기화
						elm.html(null);
						
						//safeApply
						scope.updateModel();
				}
				
				//내용 반영
				scope.updateModel = function () {

						//현재 적용 단계								
						var phase = scope.$$phase;
						
						//실행할 함수
						var fn = function () {

								//결과 출력
								scope.convert(elm.html().toString());

								//뷰에 반영
								ctrl.$setViewValue(elm.html());
						};
						
						//safeApply
						if(phase == '$apply' || phase == '$digest') {
								if(fn && (typeof(fn) === 'function')) {
										fn();
								}
						} else {
								scope.$apply(fn);
						}
				};

				//키보드 입력 이벤트
				elm.unbind('keyup').bind('keyup', scope.updateModel);
			}
		};
    })
    .controller('ctrl', function ($scope) {
		var contentEditor = document.getElementById('contentEditor');
		
		//포맷 변환
		$scope.convert = function (str) {
				
			//\n 처리
			str = str.replace(/\n/gi, "");
			
			//예외처리
			str = str.replace(/<span[^<>]*?>/gi, "");
			str = str.replace(/<\/span>/gi, "");
			str = str.replace(/<font[^<>]*?>/gi, "");
			str = str.replace(/<\/font>/gi, "");
			str = str.replace(/<p>|<p [^<>]*?>/gi, "");
			str = str.replace(/<\/p>/gi, "<p>\n"); //IE의 특성을 고려해 <p>로 행을 시작하므로 끝에 <p>를 붙인다.
			str = str.replace(/<o:p>/gi, "");
			str = str.replace(/<\/o:p>/gi, "");
			str = str.replace(/<blockquote[^<>]*?><\/blockquote>/gi, "");

			//&nbsp;처리
			str = str.replace(/&nbsp;/gi, " ");
			
			//<H?> 처리
			str = str.replace(/<h[0-9]+>|<h[0-9]+ [^<>]*?>/gi, "");
			str = str.replace(/<\/h[0-9]+>/gi, "<p>\n");

			//<p> 처리
			str = str.replace(/<div[^<>]*?>/gi, "<p>\n"); //크롬 특성상 <div><br></div> 로 개형되므로 앞에 <p>를 붙임.
			str = str.replace(/<br>/gi, "");
			str = str.replace(/<\/div>/gi, "");

			//<p><p> 처리
			str = str.replace(/<p>[\n| ]*<p>/gi, "<P>\n");

			//<b>처리
			str = str.replace(/<b>|<strong>/gi, "<B>");
			str = str.replace(/<\/b>|<\/strong>/gi, "</D>");

			//<i>처리
			str = str.replace(/<i>|<em>/gi, "<I>");
			str = str.replace(/<\/i>|<\/em>/gi, "</D>");
			
			//<sup>처리
			str = str.replace(/<sup>/gi, "<207>");
			str = str.replace(/<\/sup>/gi, "</190>");
			
			//<sub>처리
			str = str.replace(/<sub>/gi, "<209>");
			str = str.replace(/<\/sub>/gi, "</190>");
			
			//<ul, ol>처리
			str = str.replace(/<li>/gi, "\n	<li>");
			str = str.replace(/<\/li>/gi, "");
			str = str.replace(/<\/ul>/gi, "</li>\n</ul>\n");
			str = str.replace(/<\/ol>/gi, "</li>\n</ol>\n");
			
			//<blockquote> 처리
			str = str.replace(/<blockquote[^<>]*?>[<p>|]*/gi, "<div style=\"margin-left:20px\">");
			str = str.replace(/<\/blockquote>/gi, "</div>\n");

			$scope.converted = str;
		};

		//포맷 적용
		$scope.setFormat = function (sCmd, sValue) {
				
			//포맷 적용
			if( sValue && sValue.length ) {
					document.execCommand(sCmd, false, sValue);		
			}
			else {
					document.execCommand(sCmd);
			}
			
			
			//blockquote 제거 - 크롬 버그
			var blockquotes = angular.element(contentEditor).find('blockquote');
			for(var i=0, item; item = blockquotes[i]; i++){
					if( !item.innerHTML.length ){
							angular.element(item).remove();
					}
			}
			
			//safeApply
			$scope.updateModel();
			
			//포커스 적용
			contentEditor.focus();
		};
    });
</script>
</head>
<body>
	<div ng-app="directive" ng-controller="ctrl"> 
		<div>
			<div class="btn-group">
				<button class="btn btn-primary" ng-click="setFormat('bold');"><i class="icon-bold icon-white"></i> 굵게</button>
				<button class="btn btn-primary" ng-click="setFormat('italic');"><i class="icon-italic icon-white"></i> 이탤릭</button>
				<button class="btn btn-primary" ng-click="setFormat('superscript');"><i class="icon-arrow-up icon-white"></i> 위첨자</button>
				<button class="btn btn-primary" ng-click="setFormat('subscript');"><i class="icon-arrow-down icon-white"></i> 아래첨자</button>
				<button class="btn btn-warning" ng-click="setFormat('removeFormat')"><i class="icon-remove icon-white"></i> 태그 제거</button>
			</div>
			
			<div class="btn-group">
				<button class="btn btn-primary" ng-click="setFormat('insertorderedlist');"><i class="icon-list icon-white"></i> 순번 목록</button>
				<button class="btn btn-primary" ng-click="setFormat('insertunorderedlist');"><i class="icon-list icon-white"></i> 무순번 목록</button>
			</div>
			
			<div class="btn-group">
				<button class="btn btn-primary" ng-click="setFormat('outdent'); setFormat('indent');"><i class="icon-indent-left icon-white"></i> 들여쓰기</button>
				<button class="btn btn-warning" ng-click="setFormat('outdent');"><i class="icon-remove icon-white"></i> 들여쓰기 취소</button>
			</div>
			
			<div class="btn-group">		
				<button class="btn btn-danger" ng-click="init();"><i class="icon-file icon-white"></i> 초기화</button>
			</div>
			
			<span class="badge">for my cute girl</span>
		</div>
		
		<blockquote>
			<p><strong>내용 입력</strong></p>
			<small>여기에 입력하면 아래 <b>변환 결과</b>에 태그가 적용됩니다. Ctrl + B 로 '굵게', Ctrl + I 로 '이탤릭' 을 쉽게 설정할 수 있습니다.</small>
		</blockquote>
		<div id="contentEditor" contentEditable="true" ng-model="content"></div> 
		
		<blockquote>
			<p><strong>변환 결과</strong></p>
			<small>클릭하면 복사하기 쉽도록 전체 선택이 됩니다.</small>
		</blockquote>
		<textarea onclick="this.select();" ng-model="converted"></textarea>
    </div>
</body>


</html>

